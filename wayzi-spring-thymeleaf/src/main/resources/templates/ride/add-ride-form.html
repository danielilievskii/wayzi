<div class="custom-container mt-5 mb-5">
    <form id="form" class="bg-white p-4 rounded" th:action="@{/rides/add}" th:method="post" th:object="${ride}">
        <div class="row">
            <div class="col-md-6 mb-3 position-relative">
                <label for="leavingFrom" class="form-label">Leaving from:</label>
                <div class="input-group">
                    <input type="text" id="leavingFrom" class="form-control" th:field="*{departureLocationName}" onkeyup="fetchLocations(this.value, 'leavingFrom')" placeholder="e.g. Skopje">
                    <input type="hidden" id="leavingFromId" th:field="*{departureLocationId}">
                    <span class="input-group-text"><i class="fa-solid fa-location-dot"></i></span>
                </div>
                <div id="leavingFromSuggestions"
                     class="list-group position-absolute w-100 shadow"
                     style="z-index: 1000; margin-top: 10px">
                </div>
                <span th:if="${#fields.hasErrors('departureLocationId')}" th:text="${#fields.errors('departureLocationId')[0]}" style="color: red;"></span>
            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Departure time:</label>
                <div class="input-group">
                    <input type="datetime-local" id="datePickerDeparture"  class="form-control" th:field="*{departureTime}" />
                    <span class="input-group-text" onclick="document.getElementById('datePickerDeparture').showPicker()">
                        <i class="fa-solid fa-calendar"></i>
                    </span>
                </div>
                <span th:if="${#fields.hasErrors('departureTime')}" th:text="${#fields.errors('departureTime')[0]}" style="color: red;"></span>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3 position-relative">
                <label for="goingTo" class="form-label">Going to:</label>
                <div class="input-group">
                    <input type="text" id="goingTo" class="form-control" th:field="*{arrivalLocationName}" onkeyup="fetchLocations(this.value, 'goingTo')" placeholder="e.g. Ohrid">
                    <input type="hidden" id="goingToId" th:field="*{arrivalLocationId}">
                    <span class="input-group-text"><i class="fa-solid fa-location-dot"></i></span>
                </div>
                <div id="goingToSuggestions"
                     class="list-group position-absolute w-100 shadow"
                     style="z-index: 1000; margin-top: 10px">
                </div>
                <span th:if="${#fields.hasErrors('arrivalLocationId')}" th:text="${#fields.errors('arrivalLocationId')[0]}" style="color: red;"></span>

            </div>

            <div class="col-md-6 mb-3">
                <label class="form-label">Arrival time:</label>
                <div class="input-group">
                    <input type="datetime-local" id="datePickerArrival" class="form-control" th:field="*{arrivalTime}" />
                    <span class="input-group-text" onclick="document.getElementById('datePickerArrival').showPicker()">
                        <i class="fa-solid fa-calendar"></i>
                    </span>
                </div>
                <span th:if="${#fields.hasErrors('arrivalTime')}" th:text="${#fields.errors('arrivalTime')[0]}" style="color: red;"></span>

            </div>
        </div>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label">Vehicle:</label>
                <select class="form-select" aria-label="Select a vehicle" th:field="*{vehicleId}">
                    <option th:each="vehicle : ${vehicles}" th:value="${vehicle.getId()}" th:text="${vehicle.getName()}"></option>
                </select>
                <span th:if="${#fields.hasErrors('vehicleId')}" th:text="${#fields.errors('vehicleId')[0]}" style="color: red;"></span>

            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Available seats:</label>
                <div class="input-group">
                    <input type="number" class="form-control" th:field="*{availableSeats}" min="1" />
                    <span class="input-group-text"><i class="fa-solid fa-users"></i></span>
                </div>
                <span th:if="${#fields.hasErrors('availableSeats')}" th:text="${#fields.errors('availableSeats')[0]}" style="color: red;"></span>

            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label">Price per seat:</label>
                <div class="input-group">
                    <input type="number" class="form-control" th:field="*{pricePerSeat}" min="0" />
                    <span class="input-group-text"><strong>MKD</strong></span>
                </div>
                <span th:if="${#fields.hasErrors('pricePerSeat')}" th:text="${#fields.errors('pricePerSeat')[0]}" style="color: red;"></span>
            </div>
        </div>

        <div class="or-thing mb-3">
            <span>Intermediate stops</span>
        </div>

        <div id="stopsContainer"></div>

        <button type="button" class="btn custom-btn" onclick="addStop()">+ Add stop</button>

        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-light ml-2">Cancel</button>
            <button type="submit" class="btn btn-primary ml-2">Save</button>
        </div>
    </form>
</div>

<style>
    .form-label {
        margin-bottom: 8px;
    }

</style>


<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        let today = new Date();
        let formattedDateDeparture = today.toISOString().slice(0, 16);
        document.getElementById("datePickerDeparture").value = formattedDateDeparture;

        let arrivalDate = new Date(today);
        arrivalDate.setHours(arrivalDate.getHours() + 1);
        let formattedDateArrival = arrivalDate.toISOString().slice(0, 16);
        document.getElementById("datePickerArrival").value = formattedDateArrival;

        let rideStops = /*[[${rideStops}]]*/ [];
        rideStops.forEach((stop, index) => {
            addStop(stop, index);
        });
    });


    function addStop(stop = null, stopCount = null) {

        let stopsContainer = document.getElementById("stopsContainer");
        stopCount = stopCount !== null ? stopCount : stopsContainer.children.length;
        let numStop = stopCount + 1;

        let locationName = stop ? stop.locationName : "";
        let locationId = stop ? stop.locationId : "";
        let stopTime = stop ? stop.stopTime : new Date().toISOString().slice(0, 16);

        let stopDiv = document.createElement("div");
        stopDiv.classList.add("row", "g-2", "d-flex", "align-items-end");

        stopDiv.innerHTML = `
            <div class="col-md-1 mb-3">
                <p>No. <span id="numStop${stopCount}">${numStop}</span></p>
            </div>

            <div class="col-md-5 mb-3 position-relative">
                <label class="form-label">Stop location:</label>
                <input type="text" id="stop${stopCount}" name="rideStops[${stopCount}].locationName" class="form-control"
                       value="${locationName}" onkeyup="fetchLocations(this.value, this.id)"
                       placeholder="e.g. Dojran">
                <input type="hidden" name="rideStops[${stopCount}].locationId" id="stop${stopCount}Id" value="${locationId}">
                <div id="stop${stopCount}Suggestions" class="list-group position-absolute w-100" style="z-index: 1000;"></div>
                <span id="stop${stopCount}Error" style="color: red;"></span>
            </div>

            <div class="col-md-5 mb-3">
                <label class="form-label">Stop time:</label>
                <input type="datetime-local" class="form-control" id="datePickerStop${stopCount}"
                       name="rideStops[${stopCount}].stopTime" required value="${stopTime}">
                <span id="timeStop${stopCount}Error" style="color: red;"></span>
            </div>

            <div class="col-md-1 mb-3">
                <button type="button" class="btn custom-btn w-100" onclick="removeStop(this)">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        `;

        stopsContainer.appendChild(stopDiv);
    }

    function removeStop(button) {
        button.closest('.row').remove();
        updateStopNumbers();
    }

    function updateStopNumbers() {
        let stops = document.querySelectorAll("#stopsContainer .row");
        stops.forEach((stop, index) => {
            stop.querySelector("span[id^='numStop']").textContent = index + 1;
            stop.querySelector("input[name^='rideStops']").name = `rideStops[${index}].locationName`;
            stop.querySelector("input[name^='rideStops']").id = `stop${index}`;
        });
    }

    function fetchLocations(query, type) {
        document.getElementById(type + "Id").value = "";

        if (query.length < 0) {
            document.getElementById(type + "Suggestions").innerHTML = "";
            return;
        }

        fetch(`/api/locations/search?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(locations => {
                let suggestionsList = document.getElementById(type + "Suggestions");
                suggestionsList.innerHTML = "";

                locations.slice(0, 10).forEach(location => {
                    let item = document.createElement("button");
                    item.className = "list-group-item list-group-item-action";
                    item.textContent = location.displayName;
                    item.onclick = function(event) {
                        event.preventDefault();
                        document.getElementById(type).value = location.displayName;
                        document.getElementById(type + "Id").value = location.id;
                        suggestionsList.innerHTML = "";
                    };
                    suggestionsList.appendChild(item);
                });
            })
            .catch(error => console.error("Error fetching locations:", error));
    }

    // Form validation before submission
    document.getElementById("form").addEventListener("submit", function(event) {
        let isValid = true;

        // Loop through each stop and validate location and time
        let stops = document.querySelectorAll('[id^="numStop"]');
        stops.forEach((stop, index) => {

            let stopLocationId = document.getElementById(`stop${index}Id`);
            let stopTime = document.getElementById(`datePickerStop${index}`);

            console.log(stopLocationId)
            console.log(stopTime)

            if (!stopLocationId.value) {
                document.getElementById(`stop${index}Error`).innerText = "Stop location is required.";
                console.log("Adding stop location error")
                isValid = false;
            } else {
                document.getElementById(`stop${index}Error`).innerText = "";
            }

            if (!stopTime.value) {
                document.getElementById(`timeStop${index}Error`).innerText = "Stop time is required.";
                console.log("Adding stop time error")
                isValid = false;
            }
        });

        if (!isValid) {
            event.preventDefault();  // Prevent form submission if invalid
        }
    });
</script>